<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title></title>
<script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.0/fabric.min.js"></script>
<style>
#c {
   border: 1px solid black;
}
#count {
  font-weight: bold;
  margin-left: 2em;
}
</style>
</head>
<body>
<h1>Flappy Ball</h1>
<p id="count">0</p>
<div>
  <canvas id="c"></canvas>
</div>
<script>
var startFlag    = false,
    gameOverFlag = false,
    passCount    = 0,
    canvas       = new fabric.Canvas('c'),
    canvasHeight = 300,
    canvasWidth  = 600,
    floor        = canvasHeight,
    roof         = 0,
    ball         = null,
    blocks       = [],
    createBall   = function(){
      var ballRadius = 10,
          ball = new fabric.Circle({
            top: canvasHeight / 2 - ballRadius,
            left: 100,
            fill: 'red',
            strokeWidth: 0,
            radius: ballRadius
          });
      ball.flapFlag = false;
      ball.fallFlag = false;
      ball.fall = function(){
        var that = this;

        if (that.fallFlag) return;

        that.fallFlag = true;
        that.animate('top', floor, {
          duration: 600,
          onChange: function(){
            that.setCoords();
            ballBottom = that.get('top') + that.get('radius');
            if (ballBottom >= floor) gameOverFlag = true;
            else canvas.renderAll();
          },
          onComplete: function(){ that.fallFlag = false; },
          easing: fabric.util.easeInSine,
          abort: function(){
            return that.flapFlag || !startFlag || gameOverFlag;
          }
        });
      };
      ball.flap = function(){
        var that = this,
            flapValue = canvasHeight / 30 * 4;
        that.flapFlag = true;
        that.animate('top', '-=' + flapValue, {
          duration: 200,
          onChange: function(){
            that.setCoords();
            canvas.renderAll();
          },
          onComplete: function(){
            that.flapFlag = false;
          },
          easing: fabric.util.easeOutBack
        });
      };
      return ball;
    },
    calcBlockPosition = function(){
      var boxHeight          = Math.floor(canvasHeight / 10),
          floorBlockBoxCount = Math.floor(Math.random() * 6 + 1),
          floorBlockTop      = (10 - floorBlockBoxCount) * boxHeight,
          floorBlockHeight   = boxHeight * floorBlockBoxCount,
          roofBlockBoxCount  = 10 - 3 - floorBlockBoxCount,
          roofBlockTop       = -10000,
          roofBlockHeight    = 10000 + boxHeight * roofBlockBoxCount;
      return {
        roofBlockTop: roofBlockTop,
        roofBlockHeight: roofBlockHeight,
        floorBlockTop: floorBlockTop,
        floorBlockHeight: floorBlockHeight
      };
    },
    createBlock = function(top_position, height, isCall){
      var blockWidth = 100,
          block = new fabric.Rect({
            left:       canvasWidth + 200,
            top:        top_position,
            fill:       'blue',
            width:      blockWidth,
            height:     height,
            selectable: false
          });
      block.isShow = false;
      block.isPassed = false;
      block.on('added', function(){
        var that = this;
        that.animate('left', -blockWidth, {
          duration: 5000,
          onChange: function(){
            that.setCoords();
            if (startFlag && !that.isShow && that.left <= canvasWidth - blockWidth) {
              that.isShow = true;
              if (isCall) createBlockPair();
            }
            if (!block.isPassed && (that.left + that.width) <= ball.left) {
              block.isPassed = true;
              if (isCall) passCount++;
            }
            if (that.intersectsWithObject(ball)) gameOverFlag = true;
            else canvas.renderAll();
          },
          onComplete: function(){ that.remove(); },
          easing: function(t, b, c, d) { return c*t/d + b; },
          abort: function(){ return !startFlag; }
        });
      });
      return block;
    },
    createBlockPair = function(){
      var o = calcBlockPosition(),
          roofBlock  = createBlock(o.roofBlockTop, o.roofBlockHeight, true),
          floorBlock = createBlock(o.floorBlockTop, o.floorBlockHeight, false);
      blocks.push(roofBlock);
      blocks.push(floorBlock);
      canvas.add(roofBlock);
      canvas.add(floorBlock);
    }
    gameStart = function(){
      startFlag = true;
    },
    gameOver = function(){
      gameOverFlag = false;
      startFlag = false;
      alert('GAME OVER!!');
      gameReady();
    },
    gameReady = function(){
      canvas.clear();
      if (ball) ball.remove();
      for (var i=0,l=blocks.length; i<l; i++) {
        blocks[i].remove();
      }
      passCount = 0;
      ball = createBall();
      canvas.add(ball);
    }
    ;

canvas.setWidth(canvasWidth);
canvas.setHeight(canvasHeight);
canvas.on('mouse:down', function(options) {
  if (startFlag) {
    ball.flap();
  } else {
    gameStart();
    createBlockPair();
  }
});

setInterval(function(){
  if (startFlag) {
    ball.fall();
    document.getElementById('count').firstChild.nodeValue= passCount;
  }
  if (gameOverFlag) {
    gameOverFlag = false;
    gameOver();
    document.getElementById('count').firstChild.nodeValue= passCount;
  }
}, 10);

gameReady();
</script>
</body>
</html>
