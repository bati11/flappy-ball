<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title></title>
<script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.0/fabric.min.js"></script>
<style>
#c {
   border: 1px solid black;
}
</style>
</head>
<body>
<h1>Flappy Ball</h1>
<div>
  <canvas id="c"></canvas>
</div>
<input type="button" onclick="game_start()" value="START!"/>
<script>
var start_flag      = false,
    flap_flag       = false,
    drop_flag       = false,
    canvas          = new fabric.Canvas('c'),
    canvas_height   = 300,
    canvas_width    = 500,
    floor           = canvas_height,
    roof            = 0,
    ball_radius     = 10,
    ball            = new fabric.Circle({
      left: 100,
      top:  canvas_height / 2 - ball_radius,
      fill: 'red',
      radius: ball_radius
    }),
    fall = function(){
      ball.set('top', ball.get('top') + 2);
      canvas.renderAll();
    },
    flap = function(){
      flap_flag = true;
      ball.animate('top', '-=50', {
        onChange: canvas.renderAll.bind(canvas),
        duration: 150,
        onComplete: function(){
          flap_flag = false;
        }
      });
    },
    create_block = function(top_position){
      var block = new fabric.Rect({
        left:   canvas_width,
        top:    top_position,
        fill:   'blue',
        width:  50,
        height: 100
      })
      block.on('added', function(){
        var that = this;
        that.animate('left', -that.width, {
          duration: 4000,
          onChange: canvas.renderAll.bind(canvas),
          onComplete: function(){
            that.remove();
          }
        });
      });
      return block;
    },
    create_block_pair = function(){
      roof_block = create_block(0);
      floor_block = create_block(200);
      return {
        roof_block: roof_block,
        floor_block: floor_block
      }
    },
    game_start = function(){
      setInterval(function(){
        if (!flap_flag) fall();
      }, 10);
    },
    game_over = function(){
      alert('DETH!!');
    }
    ;

canvas.setWidth(canvas_width);
canvas.setHeight(canvas_height);
canvas.on('mouse:down', function(options) {
  if (start_flag) {
    flap();
  } else {
    start_flag = true;
    game_start();
    blocks = create_block_pair();
    console.log(blocks);
    canvas.add(blocks.roof_block);
    canvas.add(blocks.floor_block);
  }
});
canvas.add(ball);
</script>
</body>
</html>
