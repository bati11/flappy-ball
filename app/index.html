<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title></title>
<script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.0/fabric.min.js"></script>
<style>
#c {
   border: 1px solid black;
}
#count {
  font-weight: bold;
  margin-left: 2em;
}
</style>
</head>
<body>
<h1>Flappy Ball</h1>
<p id="count">0</p>
<div>
  <canvas id="c"></canvas>
</div>
<script>
var state        = null,
    passCount    = 0,
    canvas       = new fabric.Canvas('c'),
    canvasHeight = 300,
    canvasWidth  = 600,
    canvasColor  = '#88c6e4',
    floor        = canvasHeight,
    roof         = 0,
    ball         = null,
    linear       = function(t, b, c, d) { return c*t/d + b; },
    blocks       = [],
    blockColors  = ['#b25424', '#ac613c', '#cc9528', '#7a6334', '#612406'],
    createBall   = function(){
      var ballRadius = 10,
          ball = new fabric.Ellipse({
            top: canvasHeight / 2 - (3 * ballRadius),
            left: 100,
            fill: 'red',
            strokeWidth: 0,
            rx: 15,
            ry: ballRadius
          });
      ball.flapFlag = false;
      ball.fallFlag = false;
      ball.fall = function(){
        var that = this;

        if (that.fallFlag) return;

        that.fallFlag = true;
        that.animate('top', floor, {
          duration: 700,
          onChange: function(){
            that.setCoords();
            ballBottom = that.get('top') + that.get('ry');
            if (ballBottom >= floor) {
              state = 'playEnd';
            }
            else canvas.renderAll();
          },
          onComplete: function(){ that.fallFlag = false; },
          easing: fabric.util.easeInExpo,
          abort: function(){
            return that.flapFlag || state !== 'play';
          }
        });
        that.animate('angle', 70, {
          onChange: canvas.renderAll.bind(canvas),
          easing: fabric.util.easeInQunit,
          abort: function(){
            return that.flapFlag || state !== 'play';
          }
        });
      };
      ball.flap = function(){
        if (this.flapFlag) return;
        var that = this,
            flapValue = canvasHeight / 30 * 4;
        that.flapFlag = true;
        that.set('angle', 0);
        that.animate('top', '-=' + flapValue, {
          duration: 200,
          onChange: function(){
            that.setCoords();
            canvas.renderAll();
          },
          onComplete: function(){
            that.flapFlag = false;
          },
          easing: linear
        });
      };
      return ball;
    },
    calcBlockPosition = function(){
      var boxHeight          = Math.floor(canvasHeight / 10),
          floorBlockBoxCount = Math.floor(Math.random() * 6 + 1),
          floorBlockTop      = (10 - floorBlockBoxCount) * boxHeight,
          floorBlockHeight   = boxHeight * floorBlockBoxCount,
          roofBlockBoxCount  = 10 - 3 - floorBlockBoxCount,
          roofBlockTop       = -10000,
          roofBlockHeight    = 10000 + boxHeight * roofBlockBoxCount;
      return {
        roofBlockTop: roofBlockTop,
        roofBlockHeight: roofBlockHeight,
        floorBlockTop: floorBlockTop,
        floorBlockHeight: floorBlockHeight
      };
    },
    createBlock = function(top_position, height, color, isCall){
      var blockWidth = 80,
          block = new fabric.Rect({
            left:       canvasWidth + 200,
            top:        top_position,
            fill:       color,
            width:      blockWidth,
            height:     height,
            selectable: false
          });
      block.isShow = false;
      block.isPassed = false;
      block.on('added', function(){
        var that = this;
        that.animate('left', -blockWidth, {
          duration: 6000,
          onChange: function(){
            that.setCoords();
            if (state === 'play' && !that.isShow && that.left <= canvasWidth - blockWidth) {
              that.isShow = true;
              if (isCall) createBlockPair();
            }
            if (!block.isPassed && (that.left + that.width) <= ball.left) {
              block.isPassed = true;
              if (isCall) passCount++;
            }
            if (that.intersectsWithObject(ball)) {
              state = 'playEnd';
            }
            else canvas.renderAll();
          },
          onComplete: function(){ if (that.left + that.width < 0) that.remove(); },
          easing: linear,
          abort: function(){ return state !== 'play'; }
        });
      });
      return block;
    },
    createBlockPair = function(){
      var o = calcBlockPosition(),
          blockColor = (function(){
            var n = Math.floor(Math.random() * blockColors.length);
            return blockColors[n];
          }());
          roofBlock  = createBlock(o.roofBlockTop, o.roofBlockHeight, blockColor, true),
          floorBlock = createBlock(o.floorBlockTop, o.floorBlockHeight, blockColor, false);
      blocks.push(roofBlock);
      blocks.push(floorBlock);
      canvas.add(roofBlock);
      canvas.add(floorBlock);
    }
    gameStart = function(){
      state = 'play';
    },
    gameOver = function(){
      state = 'gameover';
      canvas.setBackgroundColor('#000', function(){
        canvas.renderAll();
        ball.bringToFront();
        ball.animate('top', floor, {
          onChange: function(){
            canvas.renderAll();
          },
          onComplete: function(){
            canvas.setBackgroundColor(canvasColor, canvas.renderAll.bind(canvas));
            alert('GAME OVER!!');
            state = 'gameoverEnd'
          }
        });
      });
      ball.animate('angle', 80, {onChange: canvas.renderAll.bind(canvas)});
    },
    gameReady = function(){
      state = 'ready';
      canvas.clear();
      if (ball) ball.remove();
      for (var i=0,l=blocks.length; i<l; i++) {
        blocks[i].remove();
      }
      passCount = 0;
      state = 'readyEnd';
      ball = createBall();
      canvas.add(ball);
    }
    ;

canvas.setWidth(canvasWidth);
canvas.setHeight(canvasHeight);
canvas.setBackgroundColor(canvasColor, canvas.renderAll.bind(canvas));
canvas.on('mouse:down', function(options) {
  if (state === 'readyEnd') {
    gameStart();
    createBlockPair();
  } else if (state === 'play') {
    ball.flap();
  }
});

setInterval(function(){
  if (state === 'gameoverEnd') {
    gameReady();
  } else if (state === 'play') {
    ball.fall();
  } else if (state === 'playEnd') {
    gameOver();
  }
  document.getElementById('count').firstChild.nodeValue = passCount;
}, 10);

gameReady();
</script>
</body>
</html>
