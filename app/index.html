<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title></title>
<script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.0/fabric.min.js"></script>
<style>
#c {
   border: 1px solid black;
}
</style>
</head>
<body>
<h1>Flappy Ball</h1>
<div>
  <canvas id="c"></canvas>
</div>
<script>
var startFlag    = false,
    gameOverFlag = false,
    canvas       = new fabric.Canvas('c'),
    canvasHeight = 300,
    canvasWidth  = 500,
    floor        = canvasHeight,
    roof         = 0,
    ball         = null,
    blocks       = [],
    createBall   = function(){
      var ballRadius = 10,
          ball = new fabric.Circle({
            top: canvasHeight / 2 - ballRadius,
            left: 100,
            fill: 'red',
            strokeWidth: 0,
            radius: ballRadius
          });
      ball.flapFlag = false;
      ball.fallFlag = false;
      ball.fall = function(){
        var that = this;

        if (that.fallFlag) return;

        that.fallFlag = true;
        that.animate('top', floor, {
          duration: 700,
          onChange: function(){
            that.setCoords();
            ballBottom = that.get('top') + that.get('radius');
            if (ballBottom >= floor) gameOverFlag = true;
            else canvas.renderAll();
          },
          onComplete: function(){ that.fallFlag = false; },
          easing: fabric.util.easeInSine,
          abort: function(){
            return that.flapFlag || !startFlag || gameOverFlag;
          }
        });
      };
      ball.flap = function(){
        var that = this;
        that.flapFlag = true;
        that.animate('top', '-=30', {
          duration: 200,
          onChange: function(){
            that.setCoords();
            canvas.renderAll();
          },
          onComplete: function(){
            that.flapFlag = false;
          },
          easing: fabric.util.easeOutQunit
        });
      };
      return ball;
    },
    createBlock = function(top_position){
      var blockWidth = 50,
          block = new fabric.Rect({
            left:   canvasWidth + 50,
            top:    top_position,
            fill:   'blue',
            width:  blockWidth,
            height: 100
          });
      block.isShow = false;
      block.on('added', function(){
        var that = this;
        that.animate('left', -blockWidth, {
          duration: 4000,
          onChange: function(){
            that.setCoords();
            if (startFlag && !that.isShow && that.left <= canvasWidth - blockWidth) {
              that.isShow = true;
              var newBlock = createBlock(top_position);
              canvas.add(newBlock);
              blocks.push(newBlock);
            }
            if (that.intersectsWithObject(ball)) gameOverFlag = true;
            else canvas.renderAll();
          },
          onComplete: function(){ that.remove(); },
          easing: function(t, b, c, d) { return c*t/d + b; },
          abort: function(){ return !startFlag || gameOverFlag; }
        });
      });
      return block;
    },
    gameStart = function(){
      startFlag = true;
    },
    gameOver = function(){
      gameOverFlag = false;
      startFlag = false;
      alert('GAME OVER!!');
      canvas.clear();
      ball.remove();
      for (var i=0,l=blocks.length; i<l; i++) {
        blocks[i].remove();
      }
      gameReady();
    },
    gameReady = function(){
      ball = createBall();
      canvas.add(ball);
    }
    ;

canvas.setWidth(canvasWidth);
canvas.setHeight(canvasHeight);
canvas.on('mouse:down', function(options) {
  if (startFlag) {
    ball.flap();
  } else {
    gameStart();
    var roofBlock  = createBlock(0);
    var floorBlock = createBlock(200);
    blocks.push(roofBlock);
    blocks.push(floorBlock);
    canvas.add(roofBlock);
    canvas.add(floorBlock);
  }
});

setInterval(function(){
  if (startFlag) ball.fall();
  if (gameOverFlag) {
    gameOverFlag = false;
    gameOver();
  }
}, 10);

gameReady();
</script>
</body>
</html>
