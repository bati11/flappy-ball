<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title></title>
<script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.0/fabric.min.js"></script>
<style>
#c {
   border: 1px solid black;
}
</style>
</head>
<body>
<h1>Flappy Ball</h1>
<div>
  <canvas id="c"></canvas>
</div>
<script>
var start_flag      = false,
    gameOverFlag    = false,
    flap_flag       = false,
    drop_flag       = false,
    canvas          = new fabric.Canvas('c'),
    canvas_height   = 300,
    canvas_width    = 500,
    floor           = canvas_height,
    roof            = 0,
    ball_radius     = 10,
    createBall      = function(){
      var ball = new fabric.Circle({
        top: canvas_height / 2 - ball_radius,
        left: 100,
        fill: 'red',
        strokeWidth: 0,
        radius: ball_radius
      });
      ball.fall = function(){
        ball.setTop(ball.get('top') + 2);
        ballBottom = ball.get('top') + ball.get('radius');
        ball.setCoords();
        if (ballBottom >= floor) gameOverFlag = true;
        else canvas.renderAll();
      };
      ball.flap = function(){
        flap_flag = true;
        ball.animate('top', '-=50', {
          onChange: function(){
            ball.setCoords();
            canvas.renderAll();
          },
          duration: 150,
          onComplete: function(){
            flap_flag = false;
          }
        });
      };
      return ball;
    },
    ball = createBall(),
    create_block = function(top_position){
      var block = new fabric.Rect({
        left:   canvas_width + 50,
        top:    top_position,
        fill:   'blue',
        width:  50,
        height: 100
      })
      block.isShow = false;
      block.on('added', function(){
        block.animate('left', -block.width, {
          duration: 4000,
          onChange: function(){
            block.setCoords();
            if (start_flag && !block.isShow && block.left <= canvas_width - 100) {
              block.isShow = true;
              canvas.add(create_block(top_position));
            }
            if (block.intersectsWithObject(ball)) {
              gameOverFlag = true;
            } else{
              canvas.renderAll();
            }
          },
          onComplete: function(){
            block.remove();
          },
          easing: function(t, b, c, d) { return c*t/d + b; }
        });
      });
      return block;
    },
    game_start = function(){
      start_flag = true;
    },
    game_over = function(){
      start_flag = false;
      alert('GAME OVER!!');
      canvas.clear();
      gameInitialize();
    },
    gameInitialize = function(){
      ball = createBall();
      canvas.add(ball);
    }
    ;

canvas.setWidth(canvas_width);
canvas.setHeight(canvas_height);

gameInitialize();
setInterval(function(){
  if (start_flag && !flap_flag) ball.fall();
  if (gameOverFlag) {
    gameOverFlag = false;
    game_over();
    }
}, 10);
canvas.on('mouse:down', function(options) {
  if (start_flag) {
    ball.flap();
  } else {
    game_start();
    var roof_block = create_block(0);
    var floor_block = create_block(200);
    canvas.add(roof_block);
    canvas.add(floor_block);
  }
});
</script>
</body>
</html>
